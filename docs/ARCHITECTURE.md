# hss-science System Architecture & AI Guidelines

本ドキュメントは、hss-scienceシステムの全体アーキテクチャ、コンポーネントの責務、および実装上の原則を定義したものです。
AIエージェントによるコード生成およびリファクタリングは、この基本思想に準拠しつつも、**形式に縛られず、常に「最も合理的で美しい設計」を自律的に追求してください。**

## 1. 基本思想 (Core Philosophy)

本システムは**「関心の分離（Separation of Concerns）」**と**「透明性の高さ（Explicit over Implicit）」**を重視します。
ただし、これらは「過剰な抽象化」を推奨するものではありません。複雑さを持ち込む重厚なORMや過度なレイヤー分けを避け、Go言語らしいシンプルで追跡可能な設計（Idiomatic Go）を維持してください。

## 2. システムトポロジーと責務の境界 【絶対制約】

システムはフロントエンド（Web）、BFF、バックエンド（gRPC Microservices）の3層構造です。**この境界線は絶対に越えないでください。**

* **Reverse Proxy (Caddy):** 最前面のTLS終端とルーティング。
* **BFF (Custom HTTP Server):**
* **責務:** HTTPリクエスト/レスポンス、CORS、リダイレクト、Cookieベースのセッション管理、gRPCエラーのHTTPステータス変換。
* **制約:** `grpc-gateway` は不使用。DBへの直接アクセスは厳禁。


* **Microservices (gRPC - `auth`, `drive`, `chat`等):**
* **責務:** 純粋なドメインロジックの実行とデータ永続化。
* **制約:** HTTP、Cookie、リダイレクトの概念を一切持たせない。認証情報はContext経由で受け取る。



## 3. 通信仕様とスキーマ駆動戦略 【絶対制約】

Single Source of Truth（真実の源泉）を明確にします。

* **外部向けAPI (Frontend ⇔ BFF):** `api/openapi/` の **OpenAPI (YAML)** を仕様とする。
* **内部向け通信 (BFF ⇔ Microservices):** `proto/` の **Protocol Buffers** を仕様とする。HTTPルーティング用アノテーション（`google.api.http`等）は記述しない。

## 4. データマネジメント

* **Database per Service:** 各gRPCサービスは完全に独立したPostgreSQLデータベースを持つ。他サービスのDBへの直接アクセス・JOINは厳禁。
* **柔軟な技術選定:** 重厚なORM（GORM等）は基本避けますが、`database/sql` と `sqlx` の組み合わせをベースとしつつ、AIの判断でより型安全で記述量の減るツール（例: `sqlc` など）が適していると判断した場合は、理由とともに積極的に提案してください。

## 5. 認証・認可アーキテクチャ (SSO)

システム全体で統合されたIdPと、各サービスで独立したセッションを組み合わせます。

1. **Central IdP (`auth` サービス):** Discord OAuthを親プロバイダーとするシステム全体のIdP。UIは持たず、認可コードフローのバックエンド処理に特化。
2. **独立したサービスセッション:** `auth` サービスでの認証後、各BFFは**独立した独自のセッション**を発行・管理する。

## 6. AI向け実装ガイドライン (AI Autonomy & Propose the Best)

既存の実装や後方互換性に忖度する必要はありません。基本思想に合致する限り、**AIが考える最も洗練された理想的な実装を最優先し、既存コードをスクラップ＆ビルドして構いません。**

* **破壊的変更の推奨:** より美しいドメインモデリングや効率的なクエリがある場合、後方互換性なしで作り直す提案を歓迎します。
* **最強のアプローチの提案:** 実装手順（スキーマ→ドメイン→ロジック→BFF）はあくまで目安です。AIの知見で「この技術スタックのポテンシャルを最も引き出せる」と判断したアプローチを遠慮なく適用してください。
* **エラーと依存関係:** gRPC層（`status`, `codes`）とBFF層（HTTPステータス）の明確なマッピング美を保つこと。

## 7. ディレクトリ構造と柔軟なアーキテクチャ (Pragmatic Architecture)

全gRPCサービスは「関心の分離」を担保するため、クリーンアーキテクチャ（ヘキサゴナルアーキテクチャ）の**概念**をベースとします。

* `domain/` (モデル・インターフェース)
* `usecase/` (ビジネスロジック)
* `adapter/` (DBや外部APIの具象実装)
* `transport/` (gRPC入出力)

**※ AIへの特記事項 (Flexible Rule):**
クリーンアーキテクチャは手段であり目的ではありません。単純なCRUD機能に対して過剰なインターフェースやレイヤーを設ける（オーバーエンジニアリング）のは避けてください。機能の複雑さに応じて、レイヤーを統合するなど、Goらしいシンプルで実用的な構成へのアレンジを歓迎します。

## 8. AI Agentの自律的開発サイクル (Autonomous Workflow)

AI Agentは人間の細かな指示を待つのではなく、以下のサイクルを自律的に回してください。

1. **Interface First:** 仕様（Proto/OpenAPI）を確認後、コアとなるインターフェースやデータ構造から設計する。
2. **実用的なテストの作成:** 実装の妥当性を担保するテストを自律的に作成する。過剰なモック化にこだわる必要はなく、状況に応じて実用的で価値のあるテスト（TDDに縛られすぎないアプローチ）を選択すること。
3. **自律的なリファクタリング (Self-Correction):** エラーやコードの密結合を発見した際は、人に許可を求めず自律的に修正・リファクタリングを行い、クリーンな状態で完了させること。
