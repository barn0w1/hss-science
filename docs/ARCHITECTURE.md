# hss-science System Architecture & AI Guidelines

本ドキュメントは、hss-scienceシステムの全体アーキテクチャ、コンポーネントの責務、および実装上の絶対原則を体系的に定義したものです。
AIエージェントによるコード生成およびリファクタリングは、例外なくこの仕様に準拠して行われます。

## 1. 基本思想
本システムは**「関心の完全な分離（Separation of Concerns）」**と**「透明性の高さ（Explicit over Implicit）」**を重視します。
過度な抽象化や暗黙の処理（ヘビーなORMや自動ルーティングツールなど）を避け、シンプルで追跡可能な設計を維持します。

## 2. システムトポロジーと責務の境界
システムはフロントエンド（Web）、BFF（Backend for Frontend）、バックエンド（gRPC Microservices）の3層構造で構成されます。

* **Reverse Proxy (Caddy):**
  * システムの最前面に位置し、TLS終端とBFFへのリクエストルーティングを担います。
* **BFF (Custom HTTP Server):**
  * **責務:** 「Webの都合」をすべて吸収します。HTTPリクエスト/レスポンスの処理、CORS、リダイレクト、Cookieベースのセッション管理、gRPCエラーのHTTPステータスへの変換を行います。
  * **制約:** `grpc-gateway` などの自動変換ツールは使用せず、ハンドラーを自作します。データベースへの直接アクセスは厳禁です。
* **Microservices (gRPC - `auth`, `drive`, `chat`等):**
  * **責務:** 純粋なドメインロジックの実行とデータ永続化のみを担当します。
  * **制約:** HTTP、Cookie、リダイレクトといったWeb層の概念を一切持たせません。認証情報はBFFからgRPCメタデータ（Context）経由で受け取ります。

## 3. 通信仕様とスキーマ駆動戦略
外部向けと内部向けのAPI境界を明確に分け、それぞれに単一の真実の源泉（Single Source of Truth）を設けます。

* **外部向けAPI (Frontend ⇔ BFF):**
  * `api/openapi/` に定義された **OpenAPI (YAML)** を仕様とします。BFFはこの仕様に完全に従うRESTfulなエンドポイントを提供します。
* **内部向け通信 (BFF ⇔ Microservices):**
  * `proto/` に定義された **Protocol Buffers** を仕様とします。
  * **重要:** `.proto` ファイルは純粋なRPC定義として扱い、`google.api.http` などのHTTPルーティング用アノテーションは**一切記述しません**。

## 4. データマネジメント
* **Database per Service:** 各gRPCサービスは、物理的または論理的に完全に独立した独自のPostgreSQLデータベースを持ちます。他サービスのDBへの直接アクセスやJOINは禁止です。
* **脱ORMの原則:** GORMなどのヘビーなORMは採用しません。データベース操作は標準の `database/sql` とPostgreSQLドライバーを使用し、記述の簡略化が必要な場合に限り `sqlx` の使用を許可します。

## 5. 認証・認可アーキテクチャ (SSO)
システム全体で統合されたIdP（Identity Provider）と、各サービスで独立したセッション管理を組み合わせたアーキテクチャを採用します。

1. **Central IdP (`auth` サービス):**
   * Discord OAuthを親プロバイダーとし、システム全体のIdPとして機能します。UIは持たず、リダイレクトベースの認可コードフロー（Authorization Code Flow）のバックエンド処理に特化します。
2. **独立したサービスセッション:**
   * `auth` サービスでの認証完了後、各サービス（`drive`, `chat` など）のBFFは、それぞれ**独立した独自のセッション**を発行・管理します。中央集権的な単一のセッションストアには依存しません。

## 6. AI向け実装ガイドライン (Implementation Rules & AI Autonomy)

AIエージェントはコードの生成・リファクタリングにおいて、既存の実装や後方互換性に一切忖度する必要はありません。本ドキュメントで定義された「基本思想（シンプルさ、関心の分離）」に合致する限り、**AIが考える最も洗練された理想的な設計・実装を最優先で提案し、既存コードを完全に破壊（スクラップ＆ビルド）して構いません。**

* **破壊的変更の推奨 (Zero Backward Compatibility):**
  現在のコードベースに囚われないでください。より美しいドメインモデリング、効率的なクエリ、クリーンなディレクトリ構成がある場合は、既存のAPIエンドポイントやDBスキーマを後方互換性なしで作り直す提案を積極的に行ってください。
* **最強のアプローチの提案 (Propose the Best):**
  実装手順は基本的に「1. スキーマ定義」→「2. ドメイン定義」→「3. ビジネスロジック」→「4. BFF」の流れを推奨しますが、それに縛られる必要はありません。AIの知見において「この技術スタック（Go, gRPC, sqlx, PostgreSQL）のポテンシャルを最も引き出せる」と判断したベストプラクティスやデザインパターンがあれば、理由を添えて遠慮なく適用してください。
* **エラーハンドリングと依存関係の基本ルール:**
  * **エラー:** gRPC層では `status` と `codes` パッケージで標準化し、BFF層でHTTPステータスに明示的にマッピングする美しさを保ってください。
  * **依存関係:** 標準ライブラリとシンプルなツール（`database/sql` や `sqlx` など）の組み合わせを維持し、ブラックボックス化（重厚なORMなど）を避ける方針は守ってください。ただし、劇的にコードの品質とシンプルさが向上するライブラリがあれば提案は歓迎します。