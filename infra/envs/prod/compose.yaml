services:
  # --- Frontend(SPA) ---
  accounts_web:
    image: ghcr.io/barn0w1/hss-science/accounts-web:latest
    container_name: accounts_web
    restart: always
    ports:
      - "127.0.0.1:8080:80"
    depends_on:
      - accounts_server
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # --- Backend ---
  accounts_server:
    image: ghcr.io/barn0w1/hss-science/accounts-server:latest
    container_name: accounts_server
    restart: always
    env_file: .env
    depends_on:
      - postgres
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # --- Database ---
  postgres:
    image: postgres:16-alpine
    container_name: postgres_prod
    restart: always
    env_file: .env
    volumes:
      - pg_data:/var/lib/postgresql/data
    labels:
      - "com.centurylinklabs.watchtower.enable=false"

  # --- Auto Deploy Agent (Watchtower) ---
  watchtower:
    image: containrrr/watchtower
    container_name: watchtower
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=60
      - WATCHTOWER_LABEL_ENABLE=true
    command: --label-enable --cleanup --interval 60

volumes:
  pg_data: