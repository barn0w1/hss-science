services:
  # --- Infrastructure Layer ---
  postgres:
    image: postgres:16-alpine
    container_name: postgres
    restart: always
    shm_size: 256mb
    env_file: [./envs/postgres.env]
    volumes:
      - pg_data:/var/lib/postgresql/data
    networks:
      - backend
    healthcheck:
      # Ensure database is ready to accept connections
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 5s
      retries: 5

  # --- Application Layer ---
  accounts-server:
    image: ghcr.io/barn0w1/hss-science/accounts-server:latest
    container_name: accounts-server
    restart: always
    env_file: 
      - ./envs/global.env
      - ./envs/accounts.env
    networks:
      - backend
    depends_on:
      postgres:
        condition: service_healthy

  accounts-web:
    image: ghcr.io/barn0w1/hss-science/accounts-web:latest
    container_name: accounts-web
    restart: always
    networks:
      - backend

  # --- Entry Point Layer ---
  gateway:
    image: caddy:2-alpine
    container_name: gateway
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - ./certs:/etc/caddy/certs
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - backend
    depends_on:
      - accounts-server
      - accounts-web

volumes:
  pg_data:
  caddy_data:
  caddy_config:

networks:
  backend:
    driver: bridge